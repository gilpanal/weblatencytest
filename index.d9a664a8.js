var e=globalThis,t={},n={},a=e.parcelRequirec15a;null==a&&((a=function(e){if(e in t)return t[e].exports;if(e in n){var a=n[e];delete n[e];var o={id:e,exports:{}};return t[e]=o,a.call(o.exports,o,o.exports),o.exports}var i=Error("Cannot find module '"+e+"'");throw i.code="MODULE_NOT_FOUND",i}).register=function(e,t){n[e]=t},e.parcelRequirec15a=a),(0,a.register)("27Lyk",function(e,t){Object.defineProperty(e.exports,"register",{get:()=>n,set:e=>n=e,enumerable:!0,configurable:!0});var n,a=new Map;n=function(e,t){for(var n=0;n<t.length-1;n+=2)a.set(t[n],{baseUrl:e,path:t[n+1]})}}),a("27Lyk").register(new URL("",import.meta.url).toString(),JSON.parse('["kqgQJ","index.d9a664a8.js","6LsJT","worker.a7e2a666.js"]'));const o=()=>{let e=document.getElementById("autocorrelationCanvas1");e.width=window.innerWidth/2,e.height=window.innerHeight/2,e.getContext("2d").clearRect(0,0,e.width,e.height);let t=document.getElementById("autocorrelationCanvas2");t.width=window.innerWidth/2,t.height=window.innerHeight/2,t.getContext("2d").clearRect(0,0,t.width,t.height);let n=document.getElementById("leftChannelCanvas");n.getContext("2d").clearRect(0,0,n.width,n.height);let a=document.getElementById("rightChannelCanvas");a.getContext("2d").clearRect(0,0,a.width,a.height)},i=(e,t,n,a)=>{let o=document.getElementById(t);!function(e,t,n,a){let o=Math.ceil(a.length/e),i=t/2;for(let t=0;t<e;t++){let e=1,r=-1;for(let n=0;n<o;n++){let i=a[t*o+n];i<e&&(e=i),i>r&&(r=i)}n.fillRect(t,(1+e)*i,1,Math.max(1,(r-e)*i))}}(o.width,o.height,o.getContext("2d"),e),function(e,t){let n=document.getElementById(t);n.width=.75*window.innerWidth,n.height=.75*window.innerHeight;let a=n.getContext("2d");a.clearRect(0,0,n.width,n.height);let o=n.width,i=n.height,r=Math.max(...e);e.forEach((t,n)=>{let l=n/e.length*(o-180)+90;a.beginPath(),a.moveTo(l,i-90),a.lineTo(l,(1-t/r)*(i-180)+90),a.strokeStyle="#FF0000",a.stroke()}),a.fillStyle="#000000",a.textAlign="center",a.textBaseline="top";let l=Math.ceil(e.length/10);for(let t=0;t<=e.length;t+=l){let n=t/e.length*(o-180)+90;a.fillText(t,n,i-45)}a.textAlign="right",a.textBaseline="middle";let s=r/5;for(let e=0;e<=5;e++){let t=(s*e).toFixed(2),n=(1-e/5)*(i-180)+90;a.fillText(t,80,n)}}(a,n)},r=(e,t)=>{let n=document.getElementById(t),a=n.getContext("2d");a.clearRect(0,0,n.width,n.height);let o={};e.forEach(e=>{let t=e.latency.toFixed(2);o[t]=(o[t]||0)+1});let i=Object.keys(o).sort((e,t)=>parseFloat(e)-parseFloat(t)),r=i.map(e=>o[e]),l=(n.width-40)/i.length,s=.2*l,d=.4*l,c=Math.max(...r),u=(n.height-30-30)/c;a.beginPath(),a.moveTo(40,30),a.lineTo(40,n.height-30),a.lineTo(n.width,n.height-30),a.stroke(),i.forEach((e,t)=>{let o=r[t],i=o*u,c=40+t*l,g=n.height-30-i;a.fillStyle="#4285F4",a.fillRect(c+d/2,g,s,i),a.fillStyle="#000",a.font="12px sans-serif",a.textAlign="center",a.fillText(e,c+l/2,n.height-10),a.fillText(o,c+l/2,g-5)}),a.fillStyle="#000",a.font="12px sans-serif",a.fillText("",5,20),a.fillText("",n.width/2,n.height-5)};class l extends Error{constructor(e){super(e),this.name="BitError"}}const s={2:[1],3:[2],4:[3],5:[2],6:[5],7:[6],8:[4,5,6],9:[5],10:[7],11:[9],12:[6,8,11],13:[4,12],14:[5,13],15:[14],16:[4,13,15]},d=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),c=`<div class='container' id='audio-area'>
                    <canvas id='leftChannelCanvas' width='800' height='100' style='border:1px solid #000000;'></canvas>
                    <canvas id='rightChannelCanvas' width='800' height='100' style='border:1px solid #000000;' hidden></canvas>
                    <br>
                    <canvas id='autocorrelationCanvas1' style='border:1px solid #000000;'></canvas>
                    <canvas id='autocorrelationCanvas2' style='border:1px solid #000000;' hidden></canvas>
                </div>`;let u=0,g=[];var h={},m={};m=function(e,t,n){if(t===self.location.origin)return e;var a=n?"import "+JSON.stringify(e)+";":"importScripts("+JSON.stringify(e)+");";return URL.createObjectURL(new Blob([a],{type:"application/javascript"}))};let f=new URL("worker.a7e2a666.js",import.meta.url);h=m(f.toString(),f.origin,!0);class p{noiseBuffer=null;debugCanvas=!1;audioContext=null;worker=null;signalrecorded=null;btnId=null;inputStream=null;recordGainNode=null;numberOfTests=1;static getCorrectStreamForSafari(e){let t=navigator.userAgent.indexOf("Version/"),n=parseFloat(navigator.userAgent.substring(t+8));if(!d||!(n>16))return e;{let t=p.audioContext.createMediaStreamSource(e);p.recordGainNode=p.audioContext.createGain(),t.connect(p.recordGainNode),p.recordGainNode.gain.value=50;let n=p.audioContext.createMediaStreamDestination();return n.channelCount=1,p.recordGainNode.connect(n),n.stream}}static async initialize(e,t,n,a,o){p.btnId=n,p.numberOfTests=o||1,p.worker=new Worker(h),p.worker.addEventListener("message",e=>{p.workerMessageHanlder(e)}),a&&(console.log("AudioContext",e),p.debugCanvas=a,document.getElementById("page-header").insertAdjacentHTML("afterend",c)),p.audioContext=e,p.onAudioPermissionGranted(t)}static onAudioPermissionGranted(e){let t=function(e,t=null){if(!(e in s))throw new l(`taps for ${e} bits unknown`);let n=s[e];if(null===t)t=Array(e).fill(1);else if(t.length!==e)throw new l(`length of seed must equal ${e}`);return function(e,t){let n=t.length,a=t.slice(),o=[];for(let t=0;t<(1<<n)-1;t++){let t=a[0];o.push(t?1:0),e.forEach(e=>{t^=a[e]}),a.push(t),a.shift()}return o}(n,t)}(parseInt(15));p.noiseBuffer=p.generateAudio(t,p.audioContext.sampleRate);let n=p.getCorrectStreamForSafari(e);p.inputStream=n,p.debugCanvas&&n.getAudioTracks().forEach(async function(e){console.log("Test Latency Track Settings",e),console.log("Test Latency Track Settings",e.getSettings())}),p.displayStart()}static displayStart(){p.content=document.getElementById(p.btnId),p.content.innerHTML="",p.startbutton=document.createElement("a"),p.startbutton.innerText="TEST LATENCY",p.startbutton.onclick=p.onAudioSetupFinished,p.content.appendChild(p.startbutton),p.debugCanvas&&o()}static async onAudioSetupFinished(){p.startbutton.innerText="STOP",p.startbutton.onclick=p.displayStart,p.prepareAudioToPlayAndrecord()}static prepareAudioToPlayAndrecord(){p.signalrecorded=null;let e=p.audioContext.createBuffer(1,2*p.audioContext.sampleRate,p.audioContext.sampleRate),t=p.audioContext.createBufferSource();t.buffer=e,t.start(0),(()=>{let e=p.audioContext.createBufferSource();e.buffer=p.noiseBuffer,e.connect(p.audioContext.destination);let t=[],n=new MediaRecorder(p.inputStream);n.ondataavailable=async e=>{t.push(e.data)},n.onstop=async()=>{e.disconnect(p.audioContext.destination),p.displayAudioTagElem(t,n.mimeType)},n.start(),e.start(),e.onended=function(){n.stop(),p.finishTest()}})()}static finishTest(){p.startbutton.innerText="PROCESSING... ",p.startbutton.onclick=p.displayStart}static async blobToAudioBuffer(e,t){let n=await t.arrayBuffer();return await e.decodeAudioData(n)}static workerMessageHanlder(e){e.data.correlation&&(p.correlation=e.data.correlation,p.worker.postMessage({command:"findpeak",array:p.correlation,channel:e.data.channel})),e.data.peakValuePow&&(p.displayresults(e.data,p.signalrecorded,p.noiseBuffer,p.correlation),0===e.data.channel&&p.testLoop())}static testLoop(){if(console.log("Looping test",++u),u<p.numberOfTests)setTimeout(()=>{p.onAudioSetupFinished()},1e3);else{u=0;let e=g.reduce((e,t)=>e+t.latency,0)/g.length,t=Math.sqrt(g.reduce((t,n)=>t+Math.pow(n.latency-e,2),0)/g.length),n=g.reduce((e,t)=>e+t.ratio,0)/g.length,a=Math.sqrt(g.reduce((e,t)=>e+Math.pow(t.ratio-n,2),0)/g.length),o=g.map(e=>e.latency),i=Math.min(...o),l=Math.max(...o);r(g,"latencyHistogram"),document.getElementById("log-message").innerText=`Mean latency: ${e.toFixed(2)} ms, Std deviation latency: ${t.toFixed(2)}, Min latency: ${i.toFixed(2)} ms, Max latency: ${l.toFixed(2)} ms, Mean ratio: ${n.toFixed(2)} dB, Std deviation ratio: ${a.toFixed(2)}`}}static async displayAudioTagElem(e,t){let n=new Blob(e,{type:t});p.signalrecorded=await p.blobToAudioBuffer(p.audioContext,n),p.debugCanvas&&(console.log("signalrecorded",p.signalrecorded),console.log("mlssignal",p.noiseBuffer)),p.correlation=null,p.worker.postMessage({command:"correlation",data1:p.signalrecorded.getChannelData(0),data2:p.noiseBuffer.getChannelData(0),maxLag:.6*p.audioContext.sampleRate,channel:0}),URL.revokeObjectURL(n)}static generateAudio(e,t){let n=p.audioContext.createBuffer(1,e.length,t),a=n.getChannelData(0);for(let t=0;t<e.length;t++)a[t]=1===e[t]?1:-1;return n}static displayresults(e,t,n,a){if(0===e.channel){let o=Number(e.peakIndex/n.sampleRate*1e3).toFixed(2),r=10*Math.log10(e.peakValuePow/e.mean);g.push({latency:Number(o),ratio:r,timestamp:Date.now()}),console.log("Corr Ratio",r),r<=18&&console.error("The Latency Test did not go well, there could be an issue with the audio settings"),p.startbutton.innerText="TEST AGAIN ",p.startbutton.innerHTML+=`<span class='badge badge-info'>lat: ${o} ms.</span><br>`,p.startbutton.innerHTML+=`<span class='badge badge-light'>ratio: ${r.toFixed(2)} dB</span>`,p.debugCanvas&&(console.log("Channel",e.channel),console.log("Latency = ",o+" ms"),i(t.getChannelData(0),"leftChannelCanvas","autocorrelationCanvas1",a),console.log("signalrecorded.numberOfChannels",t.numberOfChannels),t.numberOfChannels>1&&(document.getElementById("rightChannelCanvas").hidden=!1,document.getElementById("autocorrelationCanvas2").hidden=!1,p.correlation=null,p.worker.postMessage({command:"correlation",data1:p.signalrecorded.getChannelData(1),data2:p.noiseBuffer.getChannelData(0),maxLag:.6*p.audioContext.sampleRate,channel:1})))}else console.log("Channel",e.channel),console.log("Latency = ",e.peakIndex/n.sampleRate*1e3+" ms"),console.log("Corr Ratio",10*Math.log10(e.peakValuePow/e.mean)),i(t.getChannelData(1),"rightChannelCanvas","autocorrelationCanvas2",p.correlation)}}const x=parseInt(new URLSearchParams(window.location.search).get("numberOfTests"))||1;console.log("Number of Tests in a row: ",x);const y={audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1,latency:0,channelCount:1}};let C=null;const w=async()=>{if("wakeLock"in navigator)try{C=await navigator.wakeLock.request("screen"),console.log("Wake Lock Activated")}catch(e){C=!1,console.log("Error",e)}document.getElementById("popup").style.display="none"};(async()=>{try{let e=await navigator.mediaDevices.getUserMedia(y);console.log("stream");let t=new AudioContext({latencyHint:0});null===C&&(document.getElementById("wakeButton").onclick=w),p.initialize(t,e,"testlatencymlsbtn",!0,x)}catch(e){document.getElementById("log-message").innerText=e}})();
//# sourceMappingURL=index.d9a664a8.js.map
