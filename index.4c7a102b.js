var e=globalThis,t={},n={},a=e.parcelRequirec15a;null==a&&((a=function(e){if(e in t)return t[e].exports;if(e in n){var a=n[e];delete n[e];var o={id:e,exports:{}};return t[e]=o,a.call(o.exports,o,o.exports),o.exports}var r=Error("Cannot find module '"+e+"'");throw r.code="MODULE_NOT_FOUND",r}).register=function(e,t){n[e]=t},e.parcelRequirec15a=a),(0,a.register)("27Lyk",function(e,t){Object.defineProperty(e.exports,"register",{get:()=>n,set:e=>n=e,enumerable:!0,configurable:!0});var n,a=new Map;n=function(e,t){for(var n=0;n<t.length-1;n+=2)a.set(t[n],{baseUrl:e,path:t[n+1]})}}),a("27Lyk").register(new URL("",import.meta.url).toString(),JSON.parse('["kqgQJ","index.4c7a102b.js","6LsJT","worker.a7e2a666.js"]'));const o=()=>{let e=document.getElementById("autocorrelationCanvas1");e.width=window.innerWidth/2,e.height=window.innerHeight/2,e.getContext("2d").clearRect(0,0,e.width,e.height);let t=document.getElementById("autocorrelationCanvas2");t.width=window.innerWidth/2,t.height=window.innerHeight/2,t.getContext("2d").clearRect(0,0,t.width,t.height);let n=document.getElementById("leftChannelCanvas");n.getContext("2d").clearRect(0,0,n.width,n.height);let a=document.getElementById("rightChannelCanvas");a.getContext("2d").clearRect(0,0,a.width,a.height)},r=(e,t,n,a)=>{let o=document.getElementById(t);!function(e,t,n,a){let o=Math.ceil(a.length/e),r=t/2;for(let t=0;t<e;t++){let e=1,i=-1;for(let n=0;n<o;n++){let r=a[t*o+n];r<e&&(e=r),r>i&&(i=r)}n.fillRect(t,(1+e)*r,1,Math.max(1,(i-e)*r))}}(o.width,o.height,o.getContext("2d"),e),function(e,t){let n=document.getElementById(t);n.width=window.innerWidth/2,n.height=window.innerHeight/2;let a=n.getContext("2d");a.clearRect(0,0,n.width,n.height);let o=n.width,r=n.height,i=Math.max(...e);e.forEach((t,n)=>{let l=n/e.length*(o-40)+20;a.beginPath(),a.moveTo(l,r-20),a.lineTo(l,(1-t/i)*(r-40)+20),a.strokeStyle="#FF0000",a.stroke()}),a.fillStyle="#000000",a.textAlign="center",a.textBaseline="top";let l=Math.ceil(e.length/10);for(let t=0;t<=e.length;t+=l){let n=t/e.length*(o-40)+20;a.fillText(t,n,r-10)}a.textAlign="right",a.textBaseline="middle";let s=i/5;for(let e=0;e<=5;e++){let t=(s*e).toFixed(2),n=(1-e/5)*(r-40)+20;a.fillText(t,10,n)}}(a,n)};class i extends Error{constructor(e){super(e),this.name="BitError"}}const l={2:[1],3:[2],4:[3],5:[2],6:[5],7:[6],8:[4,5,6],9:[5],10:[7],11:[9],12:[6,8,11],13:[4,12],14:[5,13],15:[14],16:[4,13,15]},s=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),d=`<div class='container' id='audio-area'>
                    <canvas id='leftChannelCanvas' width='800' height='100' style='border:1px solid #000000;'></canvas>
                    <canvas id='rightChannelCanvas' width='800' height='100' style='border:1px solid #000000;' hidden></canvas>
                    <canvas id='autocorrelationCanvas1' style='border:1px solid #000000;'></canvas>
                    <canvas id='autocorrelationCanvas2' style='border:1px solid #000000;' hidden></canvas>
                </div>`;var c={},u={};u=function(e,t,n){if(t===self.location.origin)return e;var a=n?"import "+JSON.stringify(e)+";":"importScripts("+JSON.stringify(e)+");";return URL.createObjectURL(new Blob([a],{type:"application/javascript"}))};let g=new URL("worker.a7e2a666.js",import.meta.url);c=u(g.toString(),g.origin,!0);class h{noiseBuffer=null;debugCanvas=!1;audioContext=null;worker=null;signalrecorded=null;btnId=null;inputStream=null;recordGainNode=null;static getCorrectStreamForSafari(e){let t=navigator.userAgent.indexOf("Version/"),n=parseFloat(navigator.userAgent.substring(t+8));if(!s||!(n>16))return e;{let t=h.audioContext.createMediaStreamSource(e);h.recordGainNode=h.audioContext.createGain(),t.connect(h.recordGainNode),h.recordGainNode.gain.value=50;let n=h.audioContext.createMediaStreamDestination();return n.channelCount=1,h.recordGainNode.connect(n),n.stream}}static async initialize(e,t,n,a){h.btnId=n,h.worker=new Worker(c),h.worker.addEventListener("message",e=>{h.workerMessageHanlder(e)}),a&&(console.log("AudioContext",e),h.debugCanvas=a,document.getElementById("page-header").insertAdjacentHTML("afterend",d)),h.audioContext=e,h.onAudioPermissionGranted(t)}static onAudioPermissionGranted(e){let t=function(e,t=null){if(!(e in l))throw new i(`taps for ${e} bits unknown`);let n=l[e];if(null===t)t=Array(e).fill(1);else if(t.length!==e)throw new i(`length of seed must equal ${e}`);return function(e,t){let n=t.length,a=t.slice(),o=[];for(let t=0;t<(1<<n)-1;t++){let t=a[0];o.push(t?1:0),e.forEach(e=>{t^=a[e]}),a.push(t),a.shift()}return o}(n,t)}(parseInt(15));h.noiseBuffer=h.generateAudio(t,h.audioContext.sampleRate);let n=h.getCorrectStreamForSafari(e);h.inputStream=n,h.debugCanvas&&n.getAudioTracks().forEach(async function(e){console.log("Test Latency Track Settings",e),console.log("Test Latency Track Settings",e.getSettings())}),h.displayStart()}static displayStart(){h.content=document.getElementById(h.btnId),h.content.innerHTML="",h.startbutton=document.createElement("a"),h.startbutton.innerText="TEST LATENCY",h.startbutton.onclick=h.onAudioSetupFinished,h.content.appendChild(h.startbutton),h.debugCanvas&&o()}static async onAudioSetupFinished(){h.startbutton.innerText="STOP",h.startbutton.onclick=h.displayStart,h.prepareAudioToPlayAndrecord()}static prepareAudioToPlayAndrecord(){h.signalrecorded=null;let e=h.audioContext.createBuffer(1,2*h.audioContext.sampleRate,h.audioContext.sampleRate),t=h.audioContext.createBufferSource();t.buffer=e,t.start(0),(()=>{let e=h.audioContext.createBufferSource();e.buffer=h.noiseBuffer,e.connect(h.audioContext.destination);let t=[],n=new MediaRecorder(h.inputStream);n.ondataavailable=async e=>{t.push(e.data)},n.onstop=async()=>{e.disconnect(h.audioContext.destination),h.displayAudioTagElem(t,n.mimeType)},n.start(),e.start(),e.onended=function(){n.stop(),h.finishTest()}})()}static finishTest(){h.startbutton.innerText="PROCESSING... ",h.startbutton.onclick=h.displayStart}static async blobToAudioBuffer(e,t){let n=await t.arrayBuffer();return await e.decodeAudioData(n)}static workerMessageHanlder(e){e.data.correlation&&(h.correlation=e.data.correlation,h.worker.postMessage({command:"findpeak",array:h.correlation,channel:e.data.channel})),e.data.peakValuePow&&h.displayresults(e.data,h.signalrecorded,h.noiseBuffer,h.correlation)}static async displayAudioTagElem(e,t){let n=new Blob(e,{type:t});h.signalrecorded=await h.blobToAudioBuffer(h.audioContext,n),h.debugCanvas&&(console.log("signalrecorded",h.signalrecorded),console.log("mlssignal",h.noiseBuffer)),h.correlation=null,h.worker.postMessage({command:"correlation",data1:h.signalrecorded.getChannelData(0),data2:h.noiseBuffer.getChannelData(0),maxLag:.6*h.audioContext.sampleRate,channel:0}),URL.revokeObjectURL(n)}static generateAudio(e,t){let n=h.audioContext.createBuffer(1,e.length,t),a=n.getChannelData(0);for(let t=0;t<e.length;t++)a[t]=1===e[t]?1:-1;return n}static displayresults(e,t,n,a){if(0===e.channel){let o=Number(e.peakIndex/n.sampleRate*1e3).toFixed(2),i=Math.log10(e.peakValuePow/e.mean);console.log("Corr Ratio",i),i<=1.8&&console.error("The Latency Test did not go well, there could be an issue with the audio settings"),h.startbutton.innerText="TEST AGAIN ",h.startbutton.innerHTML+=`<span class='badge badge-info'>lat: ${o} ms.</span><br>`,h.startbutton.innerHTML+=`<span class='badge badge-light'>ratio: ${i.toFixed(2)}</span>`,h.debugCanvas&&(console.log("Channel",e.channel),console.log("Latency = ",o+" ms"),r(t.getChannelData(0),"leftChannelCanvas","autocorrelationCanvas1",a),console.log("signalrecorded.numberOfChannels",t.numberOfChannels),t.numberOfChannels>1&&(document.getElementById("rightChannelCanvas").hidden=!1,document.getElementById("autocorrelationCanvas2").hidden=!1,h.correlation=null,h.worker.postMessage({command:"correlation",data1:h.signalrecorded.getChannelData(1),data2:h.noiseBuffer.getChannelData(0),maxLag:.6*h.audioContext.sampleRate,channel:1})))}else console.log("Channel",e.channel),console.log("Latency = ",e.peakIndex/n.sampleRate*1e3+" ms"),console.log("Corr Ratio",Math.log10(e.peakValuePow/e.mean)),r(t.getChannelData(1),"rightChannelCanvas","autocorrelationCanvas2",h.correlation)}}const f={audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1,latency:0,channelCount:1}};(async()=>{let e=await navigator.mediaDevices.getUserMedia(f),t=new AudioContext({latencyHint:0});h.initialize(t,e,"testlatencymlsbtn",!0)})();
//# sourceMappingURL=index.4c7a102b.js.map
